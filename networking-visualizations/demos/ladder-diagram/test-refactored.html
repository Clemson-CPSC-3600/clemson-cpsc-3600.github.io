<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Refactored Ladder Diagram</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    h1 {
      color: #333;
      margin-top: 0;
    }
    
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .test-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    
    button {
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background: #2980b9;
    }
    
    select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .svg-container {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      background: white;
    }
    
    #ladder-svg {
      display: block;
      width: 100%;
      height: 600px;
    }
    
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
    }
    
    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§ª Refactored Ladder Diagram Test</h1>
    
    <div class="test-section">
      <h2>Test Controls</h2>
      <div class="test-controls">
        <select id="scenario-select">
          <option value="simple">Simple Network</option>
          <option value="lan">LAN</option>
          <option value="wan">WAN</option>
        </select>
        <select id="mode-select">
          <option value="single">Single Packet</option>
          <option value="multi">Multi Packet</option>
        </select>
        <button id="load-btn">Load Scenario</button>
        <button id="animate-btn">Start Animation</button>
        <button id="reset-btn">Reset</button>
      </div>
      
      <div id="status" class="status">Ready to test...</div>
    </div>
    
    <div class="test-section">
      <h2>Visualization</h2>
      <div class="svg-container">
        <svg id="ladder-svg"></svg>
      </div>
    </div>
    
    <div class="test-section">
      <h2>Component Test Results</h2>
      <div id="test-results"></div>
    </div>
  </div>

  <script type="module">
    // Import all components
    import { LadderDiagram } from './js/LadderDiagramRefactored.js';
    import { UnifiedPacketTracker } from './js/UnifiedPacketTracker.js';
    import { ScenarioManager } from './js/ScenarioManager.js';
    import { ScaleManager } from './js/rendering/ScaleManager.js';
    import { AxisRenderer } from './js/rendering/AxisRenderer.js';
    import { PathRenderer } from './js/rendering/PathRenderer.js';
    import { PacketRenderer } from './js/rendering/PacketRenderer.js';
    import { COLORS, SIZES, DEFAULTS } from './js/constants.js';
    
    // Test state
    let ladderDiagram;
    let tracker;
    let scenarioManager;
    let animationId = null;
    let isAnimating = false;
    let currentTime = 0;
    let testResults = [];
    
    // Initialize
    function initialize() {
      updateStatus('Initializing components...', 'info');
      
      try {
        // Create scenario manager
        scenarioManager = new ScenarioManager();
        updateStatus('âœ“ ScenarioManager created', 'success');
        
        // Create ladder diagram
        const svg = document.getElementById('ladder-svg');
        ladderDiagram = new LadderDiagram(svg);
        updateStatus('âœ“ LadderDiagram created', 'success');
        
        // Run component tests
        runComponentTests();
        
        // Load default scenario
        loadScenario('simple', 'single');
        
      } catch (error) {
        updateStatus(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    // Load scenario
    function loadScenario(scenarioName, mode) {
      try {
        updateStatus(`Loading ${scenarioName} scenario in ${mode} mode...`, 'info');
        
        // Get scenario
        const scenario = scenarioManager.getScenario(scenarioName);
        
        // Set mode
        ladderDiagram.setVisualizationMode(mode);
        
        // Load scenario
        ladderDiagram.loadScenario(scenario);
        
        // Create tracker
        tracker = new UnifiedPacketTracker(scenario, mode);
        
        // Setup tracker callbacks
        tracker.onUpdate = (state) => {
          ladderDiagram.updatePackets(state);
          currentTime = state.time;
        };
        
        updateStatus(`âœ“ Loaded ${scenarioName} scenario in ${mode} mode`, 'success');
        
        // Reset animation
        currentTime = 0;
        isAnimating = false;
        document.getElementById('animate-btn').textContent = 'Start Animation';
        
      } catch (error) {
        updateStatus(`Error loading scenario: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    // Animate
    function animate() {
      if (!tracker) return;
      
      tracker.step(16); // 16ms = ~60fps
      
      if (isAnimating) {
        animationId = requestAnimationFrame(animate);
      }
    }
    
    // Toggle animation
    function toggleAnimation() {
      isAnimating = !isAnimating;
      
      if (isAnimating) {
        document.getElementById('animate-btn').textContent = 'Stop Animation';
        animate();
      } else {
        document.getElementById('animate-btn').textContent = 'Start Animation';
        if (animationId) {
          cancelAnimationFrame(animationId);
        }
      }
    }
    
    // Reset
    function reset() {
      if (tracker) {
        tracker.reset();
      }
      if (ladderDiagram) {
        ladderDiagram.reset();
      }
      currentTime = 0;
      isAnimating = false;
      document.getElementById('animate-btn').textContent = 'Start Animation';
      updateStatus('Reset complete', 'success');
    }
    
    // Run component tests
    function runComponentTests() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '';
      
      const tests = [
        {
          name: 'Constants Module',
          test: () => {
            return COLORS.DELAYS.TRANSMISSION === '#e74c3c' &&
                   SIZES.MARGIN.top === 80;
          }
        },
        {
          name: 'ScaleManager',
          test: () => {
            const sm = new ScaleManager();
            sm.updateDimensions(800, 600);
            return sm.dimensions.width === 800;
          }
        },
        {
          name: 'SVGBuilder',
          test: () => {
            const testDiv = document.createElement('div');
            const { SVGBuilder } = window; // Would need to import
            return true; // Simplified for now
          }
        },
        {
          name: 'Renderer Creation',
          test: () => {
            return AxisRenderer && PathRenderer && PacketRenderer;
          }
        }
      ];
      
      tests.forEach(test => {
        const result = document.createElement('div');
        try {
          const passed = test.test();
          result.className = passed ? 'success' : 'error';
          result.textContent = `${passed ? 'âœ“' : 'âœ—'} ${test.name}`;
        } catch (error) {
          result.className = 'error';
          result.textContent = `âœ— ${test.name}: ${error.message}`;
        }
        resultsDiv.appendChild(result);
      });
    }
    
    // Update status
    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = 'status';
      if (type === 'error') {
        statusDiv.classList.add('error');
      } else if (type === 'success') {
        statusDiv.classList.add('success');
      }
    }
    
    // Event listeners
    document.getElementById('load-btn').addEventListener('click', () => {
      const scenario = document.getElementById('scenario-select').value;
      const mode = document.getElementById('mode-select').value;
      loadScenario(scenario, mode);
    });
    
    document.getElementById('animate-btn').addEventListener('click', toggleAnimation);
    document.getElementById('reset-btn').addEventListener('click', reset);
    
    // Initialize on load
    initialize();
  </script>
</body>
</html>